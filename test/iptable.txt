#1 ifconfig

enp0s3: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.100.5  netmask 255.255.255.0  broadcast 192.168.100.255
        inet6 fe80::cb10:d50f:35e2:815  prefixlen 64  scopeid 0x20<link>
        ether 08:00:27:b4:c7:6f  txqueuelen 1000  (Ethernet)
        RX packets 171691  bytes 179093277 (179.0 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 80668  bytes 32651038 (32.6 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 93873  bytes 41275976 (41.2 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 93873  bytes 41275976 (41.2 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

virbr1: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.122.1  netmask 255.255.255.0  broadcast 192.168.122.255
        ether 52:54:00:2b:41:29  txqueuelen 1000  (Ethernet)
        RX packets 58  bytes 7864 (7.8 KB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 39  bytes 8658 (8.6 KB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

vnet1: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet6 fe80::fc54:ff:fe62:a1cf  prefixlen 64  scopeid 0x20<link>
        ether 0e:43:7a:5f:8a:92  txqueuelen 1000  (Ethernet)
        RX packets 58  bytes 8676 (8.6 KB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 126  bytes 14875 (14.8 KB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0


#2 ip route
default via 192.168.100.1 dev enp0s3 proto dhcp metric 100
169.254.0.0/16 dev enp0s3 scope link metric 1000
192.168.100.0/24 dev enp0s3 proto kernel scope link src 192.168.100.5 metric 100
192.168.122.0/24 dev virbr1 proto kernel scope link src 192.168.122.1


#3 iptables:
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
 1993  126K libvirt-host-in  all  --  *      *       0.0.0.0/0            0.0.0.0/0
 171K  214M LIBVIRT_INP  all  --  *      *       0.0.0.0/0            0.0.0.0/0

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
  182 20670 libvirt-in  all  --  *      *       0.0.0.0/0            0.0.0.0/0
  121 16130 libvirt-out  all  --  *      *       0.0.0.0/0            0.0.0.0/0
  121 16130 libvirt-in-post  all  --  *      *       0.0.0.0/0            0.0.0.0/0
  393 66089 LIBVIRT_FWX  all  --  *      *       0.0.0.0/0            0.0.0.0/0
  393 66089 LIBVIRT_FWI  all  --  *      *       0.0.0.0/0            0.0.0.0/0
  105  9516 LIBVIRT_FWO  all  --  *      *       0.0.0.0/0            0.0.0.0/0

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
 164K   73M LIBVIRT_OUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0

Chain FI-vnet1 (1 references)
 pkts bytes target     prot opt in     out     source               destination
   25  2650 RETURN     tcp  --  *      *       192.168.122.100      192.168.100.4        tcp dpt:22 ctstate NEW,ESTABLISHED ctdir ORIGINAL
   37  2516 RETURN     udp  --  *      *       192.168.122.100      8.8.8.8              udp dpt:53 ctstate NEW,ESTABLISHED ctdir ORIGINAL
    0     0 RETURN     tcp  --  *      *       192.168.122.100      8.8.8.8              tcp dpt:53 ctstate NEW,ESTABLISHED ctdir ORIGINAL
    1    60 RETURN     tcp  --  *      *       192.168.122.100      10.11.45.53          ctstate NEW,ESTABLISHED ctdir ORIGINAL
    0     0 RETURN     tcp  --  *      *       0.0.0.0/0            10.11.45.53          ctstate ESTABLISHED ctdir REPLY
    0     0 DROP       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            #conn src/32 > 0
    0     0 RETURN     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 ctstate NEW,ESTABLISHED ctdir ORIGINAL
    0     0 RETURN     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:443 ctstate NEW,ESTABLISHED ctdir ORIGINAL
   61  4540 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0

Chain FO-vnet1 (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 ACCEPT     tcp  --  *      *       192.168.100.4        192.168.122.100      tcp spt:22 ctstate ESTABLISHED ctdir REPLY
    0     0 ACCEPT     udp  --  *      *       8.8.8.8              192.168.122.100      udp spt:53 ctstate ESTABLISHED ctdir REPLY
    0     0 ACCEPT     tcp  --  *      *       8.8.8.8              192.168.122.100      tcp spt:53 ctstate ESTABLISHED ctdir REPLY
    0     0 ACCEPT     tcp  --  *      *       10.11.45.53          192.168.122.100      ctstate ESTABLISHED ctdir REPLY
    0     0 ACCEPT     tcp  --  *      *       10.11.45.53          0.0.0.0/0            ctstate NEW,ESTABLISHED ctdir ORIGINAL
    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp spt:80 ctstate ESTABLISHED ctdir REPLY
    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp spt:443 ctstate ESTABLISHED ctdir REPLY
    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0

Chain HI-vnet1 (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     tcp  --  *      *       192.168.122.100      192.168.100.4        tcp dpt:22 ctstate NEW,ESTABLISHED ctdir ORIGINAL
    0     0 RETURN     udp  --  *      *       192.168.122.100      8.8.8.8              udp dpt:53 ctstate NEW,ESTABLISHED ctdir ORIGINAL
    0     0 RETURN     tcp  --  *      *       192.168.122.100      8.8.8.8              tcp dpt:53 ctstate NEW,ESTABLISHED ctdir ORIGINAL
    0     0 RETURN     tcp  --  *      *       192.168.122.100      10.11.45.53          ctstate NEW,ESTABLISHED ctdir ORIGINAL
    0     0 RETURN     tcp  --  *      *       0.0.0.0/0            10.11.45.53          ctstate ESTABLISHED ctdir REPLY
    0     0 DROP       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            #conn src/32 > 0
    0     0 RETURN     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 ctstate NEW,ESTABLISHED ctdir ORIGINAL
    0     0 RETURN     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:443 ctstate NEW,ESTABLISHED ctdir ORIGINAL
   12   816 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0

Chain LIBVIRT_FWI (1 references)
 pkts bytes target     prot opt in     out     source               destination
   58 10904 ACCEPT     all  --  *      virbr1  0.0.0.0/0            192.168.122.0/24     ctstate RELATED,ESTABLISHED
    0     0 REJECT     all  --  *      virbr1  0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable

Chain LIBVIRT_FWO (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 ACCEPT     all  --  virbr1 *       192.168.122.0/24     0.0.0.0/0
    0     0 REJECT     all  --  virbr1 *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable

Chain LIBVIRT_FWX (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 ACCEPT     all  --  virbr1 virbr1  0.0.0.0/0            0.0.0.0/0

Chain LIBVIRT_INP (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 ACCEPT     udp  --  virbr1 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr1 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
    3   984 ACCEPT     udp  --  virbr1 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr1 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67

Chain LIBVIRT_OUT (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 ACCEPT     udp  --  *      virbr1  0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  *      virbr1  0.0.0.0/0            0.0.0.0/0            tcp dpt:53
    3   985 ACCEPT     udp  --  *      virbr1  0.0.0.0/0            0.0.0.0/0            udp dpt:68
    0     0 ACCEPT     tcp  --  *      virbr1  0.0.0.0/0            0.0.0.0/0            tcp dpt:68

Chain libvirt-host-in (1 references)
 pkts bytes target     prot opt in     out     source               destination
   12   816 HI-vnet1   all  --  *      *       0.0.0.0/0            0.0.0.0/0           [goto]  PHYSDEV match --physdev-in vnet1

Chain libvirt-in (1 references)
 pkts bytes target     prot opt in     out     source               destination
  124  9766 FI-vnet1   all  --  *      *       0.0.0.0/0            0.0.0.0/0           [goto]  PHYSDEV match --physdev-in vnet1

Chain libvirt-in-post (1 references)
 pkts bytes target     prot opt in     out     source               destination
   63  5226 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            PHYSDEV match --physdev-in vnet1

Chain libvirt-out (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 FO-vnet1   all  --  *      *       0.0.0.0/0            0.0.0.0/0           [goto]  PHYSDEV match --physdev-out vnet1 --physdev-is-bridged



#4 iptables rules

-P INPUT ACCEPT
-P FORWARD ACCEPT
-P OUTPUT ACCEPT
-N FI-vnet1
-N FO-vnet1
-N HI-vnet1
-N LIBVIRT_FWI
-N LIBVIRT_FWO
-N LIBVIRT_FWX
-N LIBVIRT_INP
-N LIBVIRT_OUT
-N libvirt-host-in
-N libvirt-in
-N libvirt-in-post
-N libvirt-out
-A INPUT -j libvirt-host-in
-A INPUT -j LIBVIRT_INP
-A FORWARD -j libvirt-in
-A FORWARD -j libvirt-out
-A FORWARD -j libvirt-in-post
-A FORWARD -j LIBVIRT_FWX
-A FORWARD -j LIBVIRT_FWI
-A FORWARD -j LIBVIRT_FWO
-A OUTPUT -j LIBVIRT_OUT
-A FI-vnet1 -s 192.168.122.100/32 -d 192.168.100.4/32 -p tcp -m tcp --dport 22 -m conntrack --ctstate NEW,ESTABLISHED -m conntrack --ctdir ORIGINAL -j RETURN
-A FI-vnet1 -s 192.168.122.100/32 -d 8.8.8.8/32 -p udp -m udp --dport 53 -m conntrack --ctstate NEW,ESTABLISHED -m conntrack --ctdir ORIGINAL -j RETURN
-A FI-vnet1 -s 192.168.122.100/32 -d 8.8.8.8/32 -p tcp -m tcp --dport 53 -m conntrack --ctstate NEW,ESTABLISHED -m conntrack --ctdir ORIGINAL -j RETURN
-A FI-vnet1 -s 192.168.122.100/32 -d 10.11.45.53/32 -p tcp -m conntrack --ctstate NEW,ESTABLISHED -m conntrack --ctdir ORIGINAL -j RETURN
-A FI-vnet1 -d 10.11.45.53/32 -p tcp -m conntrack --ctstate ESTABLISHED -m conntrack --ctdir REPLY -j RETURN
-A FI-vnet1 -p tcp -m connlimit --connlimit-above 0 --connlimit-mask 32 --connlimit-saddr -j DROP
-A FI-vnet1 -p tcp -m tcp --dport 80 -m conntrack --ctstate NEW,ESTABLISHED -m conntrack --ctdir ORIGINAL -j RETURN
-A FI-vnet1 -p tcp -m tcp --dport 443 -m conntrack --ctstate NEW,ESTABLISHED -m conntrack --ctdir ORIGINAL -j RETURN
-A FI-vnet1 -j DROP
-A FO-vnet1 -s 192.168.100.4/32 -d 192.168.122.100/32 -p tcp -m tcp --sport 22 -m conntrack --ctstate ESTABLISHED -m conntrack --ctdir REPLY -j ACCEPT
-A FO-vnet1 -s 8.8.8.8/32 -d 192.168.122.100/32 -p udp -m udp --sport 53 -m conntrack --ctstate ESTABLISHED -m conntrack --ctdir REPLY -j ACCEPT
-A FO-vnet1 -s 8.8.8.8/32 -d 192.168.122.100/32 -p tcp -m tcp --sport 53 -m conntrack --ctstate ESTABLISHED -m conntrack --ctdir REPLY -j ACCEPT
-A FO-vnet1 -s 10.11.45.53/32 -d 192.168.122.100/32 -p tcp -m conntrack --ctstate ESTABLISHED -m conntrack --ctdir REPLY -j ACCEPT
-A FO-vnet1 -s 10.11.45.53/32 -p tcp -m conntrack --ctstate NEW,ESTABLISHED -m conntrack --ctdir ORIGINAL -j ACCEPT
-A FO-vnet1 -p tcp -m tcp --sport 80 -m conntrack --ctstate ESTABLISHED -m conntrack --ctdir REPLY -j ACCEPT
-A FO-vnet1 -p tcp -m tcp --sport 443 -m conntrack --ctstate ESTABLISHED -m conntrack --ctdir REPLY -j ACCEPT
-A FO-vnet1 -j DROP
-A HI-vnet1 -s 192.168.122.100/32 -d 192.168.100.4/32 -p tcp -m tcp --dport 22 -m conntrack --ctstate NEW,ESTABLISHED -m conntrack --ctdir ORIGINAL -j RETURN
-A HI-vnet1 -s 192.168.122.100/32 -d 8.8.8.8/32 -p udp -m udp --dport 53 -m conntrack --ctstate NEW,ESTABLISHED -m conntrack --ctdir ORIGINAL -j RETURN
-A HI-vnet1 -s 192.168.122.100/32 -d 8.8.8.8/32 -p tcp -m tcp --dport 53 -m conntrack --ctstate NEW,ESTABLISHED -m conntrack --ctdir ORIGINAL -j RETURN
-A HI-vnet1 -s 192.168.122.100/32 -d 10.11.45.53/32 -p tcp -m conntrack --ctstate NEW,ESTABLISHED -m conntrack --ctdir ORIGINAL -j RETURN
-A HI-vnet1 -d 10.11.45.53/32 -p tcp -m conntrack --ctstate ESTABLISHED -m conntrack --ctdir REPLY -j RETURN
-A HI-vnet1 -p tcp -m connlimit --connlimit-above 0 --connlimit-mask 32 --connlimit-saddr -j DROP
-A HI-vnet1 -p tcp -m tcp --dport 80 -m conntrack --ctstate NEW,ESTABLISHED -m conntrack --ctdir ORIGINAL -j RETURN
-A HI-vnet1 -p tcp -m tcp --dport 443 -m conntrack --ctstate NEW,ESTABLISHED -m conntrack --ctdir ORIGINAL -j RETURN
-A HI-vnet1 -j DROP
-A LIBVIRT_FWI -d 192.168.122.0/24 -o virbr1 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A LIBVIRT_FWI -o virbr1 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWO -s 192.168.122.0/24 -i virbr1 -j ACCEPT
-A LIBVIRT_FWO -i virbr1 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWX -i virbr1 -o virbr1 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p udp -m udp --dport 67 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p tcp -m tcp --dport 67 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p udp -m udp --dport 68 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p tcp -m tcp --dport 68 -j ACCEPT
-A libvirt-host-in -m physdev --physdev-in vnet1 -g HI-vnet1
-A libvirt-in -m physdev --physdev-in vnet1 -g FI-vnet1
-A libvirt-in-post -m physdev --physdev-in vnet1 -j ACCEPT
-A libvirt-out -m physdev --physdev-out vnet1 --physdev-is-bridged -g FO-vnet1

#nat table
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
 3389  312K LIBVIRT_PRT  all  --  *      *       0.0.0.0/0            0.0.0.0/0

Chain LIBVIRT_PRT (1 references)
 pkts bytes target     prot opt in     out     source               destination
    5   365 RETURN     all  --  *      *       192.168.122.0/24     224.0.0.0/24
    0     0 RETURN     all  --  *      *       192.168.122.0/24     255.255.255.255
    2   120 MASQUERADE  tcp  --  *      *       192.168.122.0/24    !192.168.122.0/24     masq ports: 1024-65535
   40  2720 MASQUERADE  udp  --  *      *       192.168.122.0/24    !192.168.122.0/24     masq ports: 1024-65535
    0     0 MASQUERADE  all  --  *      *       192.168.122.0/24    !192.168.122.0/24
